<?xml version="1.0" encoding="GBK"?>
<!DOCTYPE sqlMap 	
PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" 
"http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="CrmSql">
	<typeAlias alias="crminfo" type="com.nl.portal.dt.CrmInfo"/>
	<typeAlias alias="user" type="com.nl.portal.dt.UserInfo"/>
	
	<select id='queryKh' parameterClass="java.util.HashMap" resultClass="crminfo" >
        select *
		  from (select a.*, row_number() over(order by a.kh_id) rn, count(*) over() totalCount
		          from (
		          select  distinct a.kh_id,a.kh_name,a.provinces,a.city,a.region,a.kh_addr,a.kh_card,a.kh_phone1,a.kh_phone2,a.introduce_name
		          from kq_kh_info a  where is_valid =1 
		           <dynamic>
					<isNotEmpty property="kh_name">
							and a.kh_name  like '%$kh_name$%'
					</isNotEmpty>
					<isNotEmpty property="org_ids">
							 and charindex(a.region,#org_ids#) >0
					</isNotEmpty>
					<isNotEmpty property="is_ws">
						<isEqual property="is_ws" compareValue="1">
							and exists (select * from kq_ht_info b where a.kh_id=b.kh_id and b.is_valid=1)
						</isEqual>
						<isEqual property="is_ws" compareValue="0">
							and not exists (select * from kq_ht_info b where a.kh_id=b.kh_id and b.is_valid=1)
						</isEqual>
					</isNotEmpty>
					<isNotEmpty property="introduce_name">
							 and  introduce_name = #introduce_name#
					</isNotEmpty>
					<isNotEmpty property="kh_phone1">
							 and  kh_phone1 = #kh_phone1#
					</isNotEmpty>
					<isNotEmpty property="kh_phone2">
							 and  kh_phone2 = #kh_phone2#
					</isNotEmpty>
					<isNotEmpty property="kh_addr">
							and a.kh_addr  like '%$kh_addr$%'
					</isNotEmpty>
				  </dynamic>         
		                   ) a) t
		 where t.rn>(#page_num#-1)*#page_size# and #page_num#*#page_size# >= t.rn
	</select>
	<select id='queryExpKh' parameterClass="java.util.HashMap" resultClass="crminfo" >
        select *
		  from (select a.*, row_number() over(order by a.kh_id) rn, count(*) over() totalCount
		          from (
		          select  distinct a.kh_id,a.kh_name,a.provinces,a.city,a.region,a.kh_addr,a.kh_card,a.kh_phone1,a.kh_phone2,a.introduce_name
		          from kq_kh_info a  where is_valid =1 
		           <dynamic>
					<isNotEmpty property="kh_name">
							and a.kh_name  like '%$kh_name$%'
					</isNotEmpty>
					<isNotEmpty property="org_ids">
							 and charindex(a.region,#org_ids#) >0
					</isNotEmpty>
					<isNotEmpty property="introduce_name">
							 and  introduce_name = #introduce_name#
					</isNotEmpty>
				  </dynamic>         
		                   ) a) t 
	</select>
	<select id="getKhid" parameterClass="java.lang.String" resultClass="java.lang.String">
		select seq_value from kq_seq_kh_id where region_id = #region_id#
	</select>
	
	<update id="addkhid" parameterClass="java.lang.String">
	    update kq_seq_kh_id 
		   set seq_value = seq_value+1 
		   where region_id = #region_id#
	</update>
	<select id="gethtid" resultClass="java.lang.String">
		select seq_value from kq_seq_ht_id
	</select>
	
	<update id="addhtid" parameterClass="java.util.HashMap">
	    update kq_seq_ht_id 
		   set seq_value = seq_value+1 
	</update>
	<select id="gethfid" resultClass="java.lang.String">
		select seq_value from kq_seq_hf_id
	</select>
	
	<update id="addhfid" parameterClass="java.util.HashMap">
	    update kq_seq_hf_id 
		   set seq_value = seq_value+1 
	</update>
	
	<insert id="doKhAdd" parameterClass="java.util.HashMap">
		
		insert into kq_kh_info
		( 
			kh_id,
			kh_name,
			provinces,
			city,
			region,
			kh_phone1,
			kh_phone2,
			kh_addr,
			kh_card,
			introduce_name,
			create_id,
			create_date,
			is_valid

		)
		values
		(   #kh_id#,
			#kh_name#,
			#provinces#,
			#city#,
			#region#,
			#kh_phone1#,
			#kh_phone2#,
			#kh_addr#,
			#kh_card#,
			#introduce_name#,
			#create_id#,
			getdate(),
			1
		)
		
	</insert>
	
	<insert id="doYxkhAdd" parameterClass="java.util.HashMap">
		
		insert into kq_yxkh_info
		( 
			kh_id,
			kh_name,
			provinces,
			city,
			region,
			kh_phone1,
			kh_phone2,
			kh_addr,
			kh_card,
			introduce_name,
			channel_source,
			is_install,
			remark,
			create_id,
			create_date,
			is_valid

		)
		values
		(   #kh_id#,
			#kh_name#,
			#provinces#,
			#city#,
			#region#,
			#kh_phone1#,
			#kh_phone2#,
			#kh_addr#,
			#kh_card#,
			#introduce_name#,
			#channel_source#,
			#is_install#,
			#remark#,
			#create_id#,
			getdate(),
			1
		)
		
	</insert>
	
	<update id="doKhDel" parameterClass="java.util.HashMap">
	  UPDATE kq_kh_info set is_valid=0,change_id = #operator_id#,change_date = getDate() where is_valid =1 and kh_id = #kh_id#
	</update>
	
	<update id="doYxkhDel" parameterClass="java.util.HashMap">
	  UPDATE kq_yxkh_info set is_valid=0,change_id = #operator_id#,change_date = getDate() where is_valid =1 and kh_id = #kh_id#
	</update>
	
	<update id="doModifyYxkh" parameterClass="java.util.HashMap">
	  UPDATE kq_yxkh_info 
	     set is_install=1 ,
	     	 kh_phone1 = #kh_phone1#,
	     	 kh_phone2 = #kh_phone2#,
	     	 kh_addr = #kh_addr#,
	     	 kh_card = #kh_card#,
	     	 introduce_name = #introduce_name#,
	     	 channel_source = #channel_source#,
	     	 is_install = #is_install#,
	     	 remark = #remark#
	   where is_valid =1 and kh_id = #kh_id#
	</update>
	
	<insert id="copyYxkhTokh" parameterClass="java.util.HashMap">
		
		insert into kq_kh_info
		( 
			kh_id,
			kh_name,
			provinces,
			city,
			region,
			kh_phone1,
			kh_phone2,
			kh_addr,
			kh_card,
			introduce_name,
			create_id,
			create_date,
			is_valid

		)
		select kh_id,
			kh_name,
			provinces,
			city,
			region,
			kh_phone1,
			kh_phone2,
			kh_addr,
			kh_card,
			introduce_name,
			create_id,
			create_date,
			is_valid 
	    from kq_yxkh_info where kh_id = #kh_id#
		
	</insert>
	
	<select id='queryKhListById' parameterClass="java.util.HashMap" resultClass="crminfo" >
        select *
		  from (select a.*, row_number() over(order by a.kh_id) rn, count(*) over() totalCount
		          from (
		          select distinct a.kh_id,a.kh_name,a.provinces,a.city,a.region,a.kh_addr,a.kh_card,a.kh_phone1,a.kh_phone2,a.introduce_name
		          from kq_kh_info a 
		           where a.is_valid =1  
		           <dynamic>
					<isNotEmpty property="kh_id">
							and a.kh_id =  #kh_id#
					</isNotEmpty>
				  </dynamic>         
		                   ) a) t 
	</select>
	<select id='queryKhIntroduce' parameterClass="java.util.HashMap" resultClass="crminfo" >
        select *
		  from (select a.*, row_number() over(order by a.kh_id) rn, count(*) over() totalCount
		          from (
		          select distinct a.kh_id,a.kh_name,a.provinces,a.city,a.region,a.kh_addr,a.kh_card,a.kh_phone1,a.kh_phone2,a.introduce_name
		          from kq_kh_info a 
		           where a.is_valid =1  
		           <dynamic>
					<isNotEmpty property="kh_id">
							and a.introduce_name =  #kh_id#
					</isNotEmpty>
				  </dynamic>         
		                   ) a) t 
	</select>
	
	<update id="doKhEdit" parameterClass="java.util.HashMap">
	  UPDATE kq_kh_info 
	  set kh_name=#kh_name#,
	  	  provinces=#provinces#,
	  	  city=#city#,
	  	  region=#region#,
	  	  kh_phone1=#kh_phone1#,
	  	  kh_phone2=#kh_phone2#,
	  	  kh_addr=#kh_addr#,
	  	  kh_card=#kh_card#,
	  	  introduce_name=#introduce_name#,
	  	  change_id=#create_id#,
	  	  change_date=getdate()
	  where is_valid =1 
	  and kh_id = #kh_id#
	</update>
	
	
	<select id='queryHt' parameterClass="java.util.HashMap" resultClass="crminfo" >
        select *
		  from (select a.*, row_number() over(order by a.ht_date_current) rn, count(*) over() totalCount
		          from (
		          select distinct a.kh_addr,a.kh_id,a.kh_name,a.kh_card,a.kh_phone1,a.kh_phone2,a.introduce_name,
							b.ht_id,b.ht_date_first,b.ht_date_current,b.ht_pledge,b.ht_rent,b.prod_name,b.prod_code,b.ht_year,b.remark  ,b.ht_type 
					 from kq_kh_info a ,kq_ht_info b 
					where a.kh_id = b.kh_id
					  and b.is_valid =1 
					  and a.is_valid =1
		           <dynamic>
					<isNotEmpty property="org_ids">
							 and charindex(a.region,#org_ids#) >0
					</isNotEmpty>
					<isNotEmpty property="kh_id">
							and a.kh_id = #kh_id#
					</isNotEmpty>
					<isNotEmpty property="kh_name">
							and a.kh_name  like '%$kh_name$%'
					</isNotEmpty>
					
					<isNotEmpty property="ht_begin_date">
							and b.ht_date_current  >= #ht_begin_date#
					</isNotEmpty>
					<isNotEmpty property="ht_end_date">
							and   #ht_end_date# >= b.ht_date_current 
					</isNotEmpty>
					
				  </dynamic>           
		                   ) a) t
		 where t.rn>(#page_num#-1)*#page_size# and #page_num#*#page_size# >= t.rn
	</select>
	<select id='queryIntroduce' parameterClass="java.util.HashMap" resultClass="crminfo" >
       select distinct a.kh_id,a.kh_name,a.kh_addr,a.kh_phone1,a.kh_phone2,b.ht_date_first,b.ht_date_current
  from kq_kh_info a ,kq_ht_info b 
  where a.is_valid =1 
    and b.is_valid=1
    and exists (select * from kq_kh_info c where c.kh_id=#kh_id# and a.kh_name+'+'+a.kh_phone1 = c.introduce_name)  
    and a.kh_id = b.kh_id 
    order by b.ht_date_first desc
	</select>
	
	<select id='queryIntroduceByht' parameterClass="java.util.HashMap" resultClass="crminfo" >
       select distinct a.kh_id,a.kh_name,a.kh_addr,a.kh_phone1,a.kh_phone2,b.ht_date_first
  from kq_kh_info a ,kq_ht_info b 
  where a.is_valid =1 
    and b.is_valid=1
    and a.kh_id = b.kh_id
    and a.introduce_name = (select distinct t.kh_id from kq_ht_info t  where t.is_valid =1   and t.ht_id = #ht_id#  )
     order by b.ht_date_first desc
	</select>
	
	
	<insert id="doHtAdd" parameterClass="java.util.HashMap">
		
		insert into kq_ht_info
		( 
			kh_id,
			ht_id,
			ht_code,
			ht_date_first,
			ht_date_current,
			ht_pledge,
			ht_rent,
			prod_name,
			prod_code,
			ht_year,
			remark,
			create_id,
			create_date,
			is_valid

		)
		values
		(   #kh_id#,
			#ht_id#,
			#ht_code#,
			#ht_date_first#,
			#ht_date_current#,
			#ht_pledge#,
			#ht_rent#,
			#prod_name#,
			#prod_code#,
			#ht_year#,
			#remark#,
			#create_id#,
			getdate(),
			1
		)
		
	</insert>
	<insert id="doHfAdd" parameterClass="java.util.HashMap">
		
		insert into kq_hf_info
		( 
			ht_id,
			hf_id,
			hf_date_must,
			hf_type,
			hf_status,
			is_valid
		)
		values
		(   #ht_id#,#hf_id1#,CONVERT(varchar(12) , dateadd(MONTH,3,#ht_date_current#), 23 ),1,0,1),
		(   #ht_id#,#hf_id2#,CONVERT(varchar(12) , dateadd(MONTH,6,#ht_date_current#), 23 ),2,0,1),
		(   #ht_id#,#hf_id3#,CONVERT(varchar(12) , dateadd(MONTH,9,#ht_date_current#), 23 ),3,0,1),
		(   #ht_id#,#hf_id4#,CONVERT(varchar(12) , dateadd(MONTH,12,#ht_date_current#), 23 ),4,0,1)
			 
		
	</insert>
	
	
	<select id='queryhtByid' parameterClass="java.util.HashMap" resultClass="crminfo" >
        select *
		  from (select a.*, row_number() over(order by a.ht_date_current) rn, count(*) over() totalCount
		          from (
		          select distinct a.kh_addr,a.kh_id,a.kh_name,a.kh_card,a.kh_phone1,a.kh_phone2,a.introduce_name,
							b.ht_id,b.ht_code,b.ht_date_first,b.ht_date_current,b.ht_pledge,b.ht_rent,b.prod_name,b.prod_code,b.ht_year,b.remark ,b.ht_type  
					 from kq_kh_info a ,kq_ht_info b 
					where a.kh_id = b.kh_id
					  and b.is_valid =1 
					  and a.is_valid =1
		           <dynamic>
					<isNotEmpty property="ht_id">
							and b.ht_id = #ht_id#
					</isNotEmpty>
				  </dynamic>         
		                   ) a) t 
	</select>
	
	<select id='queryhtBykh' parameterClass="java.util.HashMap" resultClass="crminfo" >
        select *
		  from (select a.*, row_number() over(order by a.ht_date_current) rn, count(*) over() totalCount
		          from (
		          select distinct a.kh_addr,a.kh_id,a.kh_name,a.kh_card,a.kh_phone1,a.kh_phone2,a.introduce_name,
							b.ht_id,b.ht_code,b.ht_date_first,b.ht_date_current,b.ht_pledge,b.ht_rent,b.prod_name,b.prod_code,b.ht_year,b.remark ,b.ht_type  
					 from kq_kh_info a ,kq_ht_info b 
					where a.kh_id = b.kh_id
					  and b.is_valid =1 
					  and a.is_valid =1
		           <dynamic>
					<isNotEmpty property="kh_id">
							and b.kh_id = #kh_id#
					</isNotEmpty>
				  </dynamic>         
		                   ) a) t 
	</select>
	
	<update id="doHtEdit" parameterClass="java.util.HashMap">
		update kq_ht_info set
			ht_code=#ht_code#,
			ht_date_first=#ht_date_first#,
			ht_date_current=#ht_date_current#,
			ht_pledge=#ht_pledge#,
			ht_rent=#ht_rent#,
			prod_name=#prod_name#,
			prod_code=#prod_code#,
			ht_year=#ht_year#,
			remark=#remark#,
			change_id=#create_id#,
			change_date=getdate() 
		where is_valid=1
		  and ht_id=#ht_id#
		
	</update>
	
	<update id="doHtDel" parameterClass="java.util.HashMap">
	  UPDATE kq_ht_info set is_valid=0 where is_valid =1 and ht_id=#ht_id#
	</update>
	<update id="doHfDel" parameterClass="java.util.HashMap">
	  UPDATE kq_hf_info set is_valid=0 where is_valid =1 and ht_id=#ht_id#
	</update>
	<select id='queryHt1' parameterClass="java.util.HashMap" resultClass="crminfo" >
        select *
		  from (select a.*, row_number() over(order by a.ht_date_current) rn, count(*) over() totalCount
		          from (
		          select distinct 
		          		a.kh_addr,a.kh_id,a.kh_name,a.kh_card,a.kh_phone1,a.kh_phone2,a.introduce_name,
							b.ht_id,b.ht_date_first,b.ht_date_current,b.ht_pledge,b.ht_rent,b.prod_name,b.prod_code,b.ht_year,b.remark,b.ht_type 
					 from kq_kh_info a ,kq_ht_info b 
					where a.kh_id = b.kh_id
					  and b.is_valid =1 
					  and a.is_valid =1
		           <dynamic>
					<isNotEmpty property="org_ids">
							 and charindex(a.region,#org_ids#) >0
					</isNotEmpty>
					<isNotEmpty property="kh_name">
							and a.kh_name  like '%$kh_name$%'
					</isNotEmpty>
					<isNotEmpty property="ht_type">
							and b.ht_type  = #ht_type#
					</isNotEmpty>
					
					<isNotEmpty property="ht_begin_date">
							and b.ht_date_current  >= #ht_begin_date#
					</isNotEmpty>
					<isNotEmpty property="ht_end_date">
							and   #ht_end_date# >= b.ht_date_current 
					</isNotEmpty>
					
				  </dynamic>          
		                   ) a) t
		 where t.rn>(#page_num#-1)*#page_size# and #page_num#*#page_size# >= t.rn
	</select>
	
	<select id='queryHtExp' parameterClass="java.util.HashMap" resultClass="crminfo" >
        select *
		  from (select a.*, row_number() over(order by a.ht_date_current) rn, count(*) over() totalCount
		          from (
		          select distinct 
		          		a.kh_addr,a.kh_id,a.kh_name,a.kh_card,a.kh_phone1,a.kh_phone2,a.introduce_name,
							b.ht_id,b.ht_date_first,b.ht_date_current,b.ht_pledge,b.ht_rent,b.prod_name,b.prod_code,b.ht_year,b.remark  
					 from kq_kh_info a ,kq_ht_info b 
					where a.kh_id = b.kh_id
					  and b.is_valid =1 
					  and a.is_valid =1
		           <dynamic>
					<isNotEmpty property="org_ids">
							 and charindex(a.region,#org_ids#) >0
					</isNotEmpty>
					<isNotEmpty property="kh_name">
							and a.kh_name  like '%$kh_name$%'
					</isNotEmpty>
					
					<isNotEmpty property="ht_begin_date">
							and b.ht_date_current  >= #ht_begin_date#
					</isNotEmpty>
					<isNotEmpty property="ht_end_date">
							and   #ht_end_date# >= b.ht_date_current 
					</isNotEmpty>
					
				  </dynamic>          
		                   ) a) t 
	</select>
	
	<select id='queryOrgByUser' parameterClass="java.util.HashMap" resultClass="crminfo" >
        with cte_child(org_id,parent_org_id,org_name,data_level )
			as
			(
			   select org_id ,parent_org_id,org_name,data_level
			    from kq_region_relation 
			    where  (   
				 org_id = (select case when org_level=3 then region when org_level=2 then city else provinces end  from kq_user_region where sno =#sno#)
				  
			    )
			    union all
			    select a.org_id ,a.parent_org_id,a.org_name,a.data_level
			    from kq_region_relation a, cte_child b
			    where a.parent_org_id=b.org_id
			)  
			select * from cte_child where  data_level = 4
			order by data_level,org_id
	</select>
	
	
	<select id='queryHf' parameterClass="java.util.HashMap" resultClass="crminfo" >
        select *
		  from (select a.*, row_number() over(order by a.kh_id,a.hf_date_must) rn, count(*) over() totalCount
		          from (
			          select  distinct a.ht_id,hf_id,hf_date_must,hf_date_fact,hf_status,hf_user_name,hf_remark,hf_type,
								ht_date_current,ht_year,b.kh_id,kh_name,kh_phone1,kh_addr,kh_phone2,kh_card
						from kq_hf_info a ,kq_ht_info b,kq_kh_info c
						where a.ht_id = b.ht_id
						  and b.kh_id = c.kh_id
						  and a.is_valid=1
						  and b.is_valid=1
		           <dynamic>
					<isNotEmpty property="org_ids">
							 and charindex(c.region,#org_ids#) >0
					</isNotEmpty>
					<isNotEmpty property="kh_name">
							 and c.kh_name like '%$kh_name$%'
					</isNotEmpty>
					<isNotEmpty property="hf_status">
							 and a.hf_status = #hf_status#
					</isNotEmpty>
					<isNotEmpty property="hf_type">
							 and a.hf_type = #hf_type#
					</isNotEmpty>
					<isNotEmpty property="hf_begin_date">
							 and  a.hf_date_must >= #hf_begin_date#
					</isNotEmpty>
					<isNotEmpty property="hf_end_date">
							 and  #hf_end_date# >= a.hf_date_must 
					</isNotEmpty>
				  </dynamic>          
		                   ) a) t
		 where t.rn>(#page_num#-1)*#page_size# and #page_num#*#page_size# >= t.rn
	</select>
	<select id='queryhfByid' parameterClass="java.util.HashMap" resultClass="crminfo" >
		             
				select a.ht_id,a.hf_id,a.hf_date_must,a.hf_date_fact,a.hf_status,a.hf_user_name,hf_type,a.hf_remark 
				 from 	 kq_hf_info a 
				 where a.is_valid=1
				   and hf_id = #hf_id#
	</select>
	<select id='queryhfBykh' parameterClass="java.util.HashMap" resultClass="crminfo" >
		             
				select c.ht_id,c.hf_date_fact,c.hf_date_must,c.hf_remark,c.hf_status,c.hf_type,c.hf_user_name 
					from kq_kh_info a ,kq_ht_info b,kq_hf_info c
					where a.kh_id=b.kh_id
					  and b.ht_id=c.ht_id
					  and a.is_valid=1
					  and b.is_valid=1
					  and c.is_valid=1
				   	  and a.kh_id = #kh_id#
	</select>
	
	<update id="doHfEdit" parameterClass="java.util.HashMap">
		update kq_hf_info set
			hf_date_fact=#hf_date_fact#,
			hf_remark=#hf_remark#,
			hf_user_name=#hf_user_name# ,
			hf_status=1
		where hf_id=#hf_id# 
		  and is_valid=1
		
	</update>
	
	<update id="doHfEdit1" parameterClass="java.util.HashMap">
		update kq_hf_info set
			hf_date_fact=#hf_date_fact1#,
			hf_remark=#hf_remark1#,
			hf_user_name=#hf_user_name1# ,
			hf_status=1
		where hf_id=#hf_id1#
		  and ht_id=#ht_id#
		  and is_valid=1
		
	</update>
	<update id="doHfEdit2" parameterClass="java.util.HashMap">
		update kq_hf_info set
			hf_date_fact=#hf_date_fact2#,
			hf_remark=#hf_remark2#,
			hf_user_name=#hf_user_name2# ,
			hf_status=1
		where hf_id=#hf_id2#
		  and ht_id=#ht_id#
		  and is_valid=1
		
	</update>
	<update id="doHfEdit3" parameterClass="java.util.HashMap">
		update kq_hf_info set
			hf_date_fact=#hf_date_fact3#,
			hf_remark=#hf_remark3#,
			hf_user_name=#hf_user_name3# ,
			hf_status=1
		where hf_id=#hf_id3#
		  and ht_id=#ht_id#
		  and is_valid=1
		
	</update>
	<update id="doHfEdit4" parameterClass="java.util.HashMap">
		update kq_hf_info set
			hf_date_fact=#hf_date_fact4#,
			hf_remark=#hf_remark4#,
			hf_user_name=#hf_user_name4# ,
			hf_status=1
		where hf_id=#hf_id4#
		  and ht_id=#ht_id#
		  and is_valid=1
		
	</update>
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
</sqlMap>